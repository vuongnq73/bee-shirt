<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Bee-Shirt Admin Dashboard</title>
  <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
  <link rel="icon" href="img/kaiadmin/favicon.ico" type="image/x-icon" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">


  <!-- AngularJS -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Application Script -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-route.min.js"></script>


  <script src="/assets/js/staff.js"></script>



  <!-- Fonts and icons -->
  <script src="js/plugin/webfont/webfont.min.js"></script>
  <script>
    WebFont.load({
      google: { families: ["Public Sans:300,400,500,600,700"] },
      custom: {
        families: [
          "Font Awesome 5 Solid",
          "Font Awesome 5 Regular",
          "Font Awesome 5 Brands",
          "simple-line-icons",
        ],
        urls: ["css/fonts.min.css"],
      },
      active: function () {
        sessionStorage.fonts = true;
      },
    });
  </script>

  <!-- CSS Files -->
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <link rel="stylesheet" href="css/plugins.min.css" />
  <link rel="stylesheet" href="css/kaiadmin.min.css" />

  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link rel="stylesheet" href="css/demo.css" />
</head>

<body>
  <div class="wrapper">
    <!-- Sidebar -->
    <div class="sidebar" data-background-color="dark">
      <div class="sidebar-logo">
        <!-- Logo Header -->
        <div class="logo-header" data-background-color="dark">
          <a href="BanHang.html" class="logo">
            <img src="img/kaiadmin/logo_light.png" alt="navbar brand" class="navbar-brand" height="40" />
          </a>
          <div class="nav-toggle">
            <button class="btn btn-toggle toggle-sidebar">
              <i class="gg-menu-right"></i>
            </button>
            <button class="btn btn-toggle sidenav-toggler">
              <i class="gg-menu-left"></i>
            </button>
          </div>
          <button class="topbar-toggler more">
            <i class="gg-more-vertical-alt"></i>
          </button>
        </div>
        <!-- End Logo Header -->
      </div>
      <div class="sidebar-wrapper scrollbar scrollbar-inner">
        <div class="sidebar-content">
          <ul class="nav nav-secondary">
            <li class="nav-item active submenu">
              <a href="BanHang.html" class="collapsed" aria-expanded="false">
                <i class="fas fa-home"></i>
                <p>Bán Hàng</p>
              </a>
            </li>
            <li class="nav-section">
              <span class="sidebar-mini-icon">
                <i class="fa fa-ellipsis-h"></i>
              </span>
            </li>
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#">
                <i class="fas fa-layer-group"></i>
                <p>Quản Lý</p>
              </a>
            </li>
            <li class="nav-item">
              <a href="/assets/Voucher.html">
                <i class="fas fa-ticket-alt"></i>
                <p>Voucher</p>
              </a>

            </li>
            <li class="nav-item ">

              <a href="/assets/Bill.html">
                <i class="fas fa-pen-square"></i>
                <span class="sub-item">Hóa Đơn</span>
              </a>
            </li>
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#tables">
                <i class="fas fa-table"></i>
                <p>Sản Phẩm</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="tables">
                <ul class="nav nav-collapse">
                  <li>
                    <a href="Products.html">
                      <span class="sub-item">Danh Sách Sản Phẩm</span>
                    </a>
                  </li>

                  <li>
                    <a href="ProductDetail.html">
                      <span class="sub-item">Danh Sách Sản Phẩm Chi Tiết</span>
                    </a>
                  </li>
                  <li>
                    <a href="Category.html">
                      <span class="sub-item">Danh Sách Thuộc Tính<span>
                    </a>
                  </li>

                </ul>
              </div>
            </li>
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#account">
                <i class="fas fa-user"></i>
                <p>Account</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="account">
                <ul class="nav nav-collapse">
                  <li>

                    <a href="/assets/staff/Staff.html">
                      <span class="sub-item">Nhân Viên</span>
                    </a>
                  </li>
                  <li>

                    <a href="Customer.html">
                      <span class="sub-item">Khách Hàng</span>
                    </a>
                  </li>
                </ul>
              </div>
            </li>
            <li class="nav-item">
              <a href="statistic.html">
                <i class="far fa-chart-bar"></i>
                <p>Thống Kê</p>

              </a>

            </li>


          </ul>
        </div>
      </div>
    </div>
    <!-- End Sidebar -->

    <div class="main-panel">
      <div class="main-header">
        <div class="main-header-logo">
          <!-- Logo Header -->
          <div class="logo-header" data-background-color="dark">
            <a href="BanHang.html" class="logo">
              <img src="img/kaiadmin/logo_light.png" alt="navbar brand" class="navbar-brand" height="20" />

            </a>
            <div class="nav-toggle">
              <button class="btn btn-toggle toggle-sidebar">
                <i class="gg-menu-right"></i>
              </button>
              <button class="btn btn-toggle sidenav-toggler">
                <i class="gg-menu-left"></i>
              </button>
            </div>
            <button class="topbar-toggler more">
              <i class="gg-more-vertical-alt"></i>
            </button>
          </div>
          <!-- End Logo Header -->
        </div>
        <!-- Navbar Header -->
        <nav class="navbar navbar-header navbar-header-transparent navbar-expand-lg border-bottom">
          <div class="container-fluid">
            <ul class="navbar-nav topbar-nav ms-md-auto align-items-center">
              <li class="nav-item topbar-icon dropdown hidden-caret d-flex d-lg-none">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                  aria-expanded="false" aria-haspopup="true">
                  <i class="fa fa-search"></i>
                </a>
                <ul class="dropdown-menu dropdown-search animated fadeIn">
                  <form class="navbar-left navbar-form nav-search">
                    <div class="input-group">
                      <input type="text" placeholder="Search ..." class="form-control" />
                    </div>
                  </form>
                </ul>
              </li>
              <li class="nav-item topbar-icon dropdown hidden-caret">
                <a class="nav-link dropdown-toggle" href="#" id="messageDropdown" role="button"
                  data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="fa fa-envelope"></i>
                </a>
                <ul class="dropdown-menu messages-notif-box animated fadeIn" aria-labelledby="messageDropdown">
                  <li>
                    <div class="dropdown-title d-flex justify-content-between align-items-center">
                      Tin Nhắn
                      <a href="#" class="small">Đánh dấu tất cả các tin nhắn đã đọc</a>
                    </div>
                  </li>
                  <li>
                    <div class="message-notif-scroll scrollbar-outer">
                      <div class="notif-center">
                        <a href="#">
                          <div class="notif-img">
                            <img src="img/jm_denis.jpg" alt="Img Profile" />
                          </div>
                          <div class="notif-content">
                            <span class="subject">Jimmy Denis</span>
                            <span class="block"> How are you ? </span>
                            <span class="time">5 phút trước</span>
                          </div>
                        </a>
                        <a href="#">
                          <div class="notif-img">
                            <img src="img/chadengle.jpg" alt="Img Profile" />
                          </div>
                          <div class="notif-content">
                            <span class="subject">Nguyễn Quốc Vượng</span>
                            <span class="block"> Ok,Cảm ơn Shop nhé ! </span>
                            <span class="time">12 phút trước</span>
                          </div>
                        </a>
                        <a href="#">
                          <div class="notif-img">
                            <img src="img/mlane.jpg" alt="Img Profile" />
                          </div>
                          <div class="notif-content">
                            <span class="subject">Đỗ Trung Đăng</span>
                            <span class="block">
                              Xin chào !
                            </span>
                            <span class="time">12 phút trước</span>
                          </div>
                        </a>
                        <a href="#">
                          <div class="notif-img">
                            <img src="img/talha.jpg" alt="Img Profile" />
                          </div>
                          <div class="notif-content">
                            <span class="subject">Đỗ Trường Giang</span>
                            <span class="block"> Shop còn mẫu áo này không ? </span>
                            <span class="time">17 phút trước</span>
                          </div>
                        </a>
                      </div>
                    </div>
                  </li>
                  <li>
                    <a class="see-all" href="javascript:void(0);">Xem tất cả các tin nhắn<i
                        class="fa fa-angle-right"></i>
                    </a>
                  </li>
                </ul>
              </li>
              <li class="nav-item topbar-icon dropdown hidden-caret">
                <a class="nav-link dropdown-toggle" href="#" id="notifDropdown" role="button" data-bs-toggle="dropdown"
                  aria-haspopup="true" aria-expanded="false">
                  <i class="fa fa-bell"></i>
                  <span class="notification">4</span>
                </a>
                <ul class="dropdown-menu notif-box animated fadeIn" aria-labelledby="notifDropdown">
                  <li>
                    <div class="dropdown-title">
                      Bạn có 4 thông báo mới
                    </div>
                  </li>
                  <li>
                    <div class="notif-scroll scrollbar-outer">
                      <div class="notif-center">
                        <a href="#">
                          <div class="notif-icon notif-primary">
                            <i class="fa fa-user-plus"></i>
                          </div>
                          <div class="notif-content">
                            <span class="block"> Người dùng mới đăng ký </span>
                            <span class="time">5 phút trước</span>
                          </div>
                        </a>
                        <a href="#">
                          <div class="notif-icon notif-success">
                            <i class="fa fa-comment"></i>
                          </div>
                          <div class="notif-content">
                            <span class="block">
                              Đỗ Trường Giang đã bình luận
                            </span>
                            <span class="time">12 phút trước</span>
                          </div>
                        </a>
                        <a href="#">
                          <div class="notif-img">
                            <img src="img/profile2.jpg" alt="Img Profile" />
                          </div>
                          <div class="notif-content">
                            <span class="block">
                              Đỗ Trung Đăng đã gửi tin nhắn
                            </span>
                            <span class="time">12 phút trước</span>
                          </div>
                        </a>
                        <a href="#">
                          <div class="notif-icon notif-danger">
                            <i class="fa fa-heart"></i>
                          </div>
                          <div class="notif-content">
                            <span class="block"> Nguyễn Quốc Vượng đã like </span>
                            <span class="time">17 phút trước</span>
                          </div>
                        </a>
                      </div>
                    </div>
                  </li>
                  <li>
                    <a class="see-all" href="javascript:void(0);">Xem tất cả các thông báo<i
                        class="fa fa-angle-right"></i>
                    </a>
                  </li>
                </ul>
              </li>

              <li class="nav-item topbar-user dropdown hidden-caret" ng-if="myProfile">
                <a class="dropdown-toggle profile-pic" data-bs-toggle="dropdown" href="#" aria-expanded="false">
                  <div class="avatar-sm">
                    <!-- Hiển thị avatar của người dùng hoặc ảnh mặc định -->
                    <img src="default-avatar.jpg" alt="..." class="avatar-img rounded-circle" />
                  </div>
                  <span class="profile-username">
                    <span class="op-7">Hi,</span>
                    <span class="fw-bold">Người dùng</span> <!-- Hiển thị tên người dùng -->
                  </span>
                </a>
                <ul class="dropdown-menu dropdown-user animated fadeIn">
                  <div class="dropdown-user-scroll scrollbar-outer">
                    <li id="user-box" style="display: block;"> <!-- Ngăn hiển thị nếu thông tin chưa tải -->
                      <div class="user-box">
                        <div class="avatar-lg">
                          <img id="profile-avatar" src="default-avatar.jpg" alt="image profile"
                            class="avatar-img rounded" />
                        </div>
                        <div class="u-text">
                          <h4 id="user-name">Người dùng</h4>
                          <p class="text-muted" id="user-email">email@example.com</p>
                          <a href="/assets/staff/Profile.html" id="view-profile"
                            class="btn btn-xs btn-secondary btn-sm">View Profile</a>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="dropdown-divider"></div>
                      <a class="dropdown-item" href="/assets/account/login.html" id="logout">Logout</a>
                    </li>
                  </div>
                </ul>
              </li>

            </ul>
          </div>
        </nav>
        <!-- End Navbar -->
      </div>
      <!-- container -->
      <div class="container">
        <div class="page-inner">
          <div class="page-header">
            <h3 class="fw-bold mb-3">Bán Hàng</h3>
            <ul class="breadcrumbs mb-3">
              <li class="nav-home">
                <a href="/statistic.html">
                  <i class="fas fa-layer-group"></i>
                </a>
              </li>
              <li class="separator">
                <i class="icon-arrow-right"></i>
              </li>
              <li class="nav-item">
                <a href="/assets/BanHang.html">Bán Hàng</a>
              </li>
              <li class="separator">
                <i class="icon-arrow-right"></i>
              </li>
              <li class="nav-item">
                <a href="/assets/BanHang.html">Tạo Hóa Đơn</a>
              </li>
            </ul>
            <div class="ms-md-auto py-2 py-md-0">
              <!-- <a href="#" class="btn btn-label-info btn-round me-2">Quản Lý</a> -->
              <a class="btn btn-primary" onclick="creatBill()">Thêm Hóa Đơn</a>
            </div>
          </div>
          <!-- endheader bán hàng -->

          <div class="row">
            <nav class="navbar navbar-light bg-light p-3">
              <div class="container-fluid">
                <form id="searchForm">
                  <div class="input-group">
                    <div class="position-relative">
                      <input type="text" class="form-control" id="searchInput" placeholder="Search..."
                        onkeyup="performSearch()" autocomplete="off">
                      <ul id="suggestions" class="suggestions-list list-group position-absolute w-100"> </ul>
                    </div>
                    <button class="btn btn-outline-secondary" type="button" onclick="scanBarcode()"
                      style="margin-left: 5px;">
                      QR Code <i class="bi bi-upc-scan"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" style="margin-left: 5px;">
                      <a href="/assets/ListProducts.html">
                        <i class="bi bi-plus-square-fill"></i>

                      </a>

                    </button>
                  </div>
                </form>
                <div class="d-flex align-items-center" ng-app="staffApp" ng-controller="StaffController">
                  <!-- Nút kích hoạt Modal -->
                  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
                    Đăng ký nhanh
                  </button>

                  <!-- Modal -->
                  <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="registerModalLabel">Đăng ký nhanh</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <form ng-submit="register()">
                            <div class="mb-3">
                              <label for="firstName" class="form-label">Họ:</label>
                              <input type="text" class="form-control" id="firstName" ng-model="user.firstName"
                                required />
                            </div>
                            <div class="mb-3">
                              <label for="lastName" class="form-label">Tên:</label>
                              <input type="text" class="form-control" id="lastName" ng-model="user.lastName" required />
                            </div>
                            <div class="mb-3">
                              <label for="email" class="form-label">Email:</label>
                              <input type="email" class="form-control" id="email" ng-model="user.email" required />
                            </div>
                            <div class="mb-3">
                              <label for="phone" class="form-label">Số điện thoại:</label>
                              <input type="tel" class="form-control" id="phone" ng-model="user.phone" required />
                            </div>
                            <button type="submit" class="btn btn-success w-100" ng-disabled="isLoading">
                              {{ isLoading ? "Đang xử lý..." : "Đăng ký" }}
                            </button>
                          </form>
                        </div>
                        <div class="modal-footer">
                          <p class="text-success" ng-if="successMessage">{{ successMessage }}</p>
                          <p class="text-danger" ng-if="errorMessage">{{ errorMessage }}</p>
                          <button type="button" ng-click="cancelCreateAccount()" class="btn btn-secondary"
                            data-bs-dismiss="modal">Đóng</button>
                        </div>
                      </div>
                    </div>
                  </div>


                </div>


              </div>
            </nav>
            <div class="col-md-8">
              <!-- Bill -->
              <div class="container mt-3">
                <div class="row justify-content-center">
                  <div class="col text-center" id="bill-buttons">
                    <!-- Nơi chứa các nút sau khi lấy dữ liệu từ API -->
                    <!-- Đây sẽ là phần có thanh cuộn khi nội dung vượt quá chiều cao -->
                  </div>
                </div>

                <h2>Giỏ hàng</h2>
                <div class="table-container">
                  <table class="table table-bordered">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Mã</th>
                        <th>Tên sản phẩm</th>
                        <th>Cỡ</th>
                        <th>Màu sắc</th>
                        <th>Giá</th>
                        <th>Số lượng</th>
                        <th>Tổng</th>
                        <th>Thao tác</th>
                      </tr>
                    </thead>
                    <tbody id="billDetailsTableBody"></tbody>
                  </table>
                </div>

                <div class="row">
                  <div class="container">
                    <h2>Danh sách sản phẩm</h2>
                    <table class="table table-bordered">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>Mã</th>
                          <th>Tên sản phẩm</th>
                          <th>Cỡ</th>
                          <th>Màu sắc</th>
                          <th>Giá</th>
                          <th>Số lượng</th>
                          <th>Thao tác</th>
                        </tr>
                      </thead>
                      <tbody id="productTableBody"></tbody>
                    </table>

                    <nav>
                      <ul class="pagination" id="pagination"></ul>
                    </nav>
                  </div>

                </div>
                <!-- Repeat for other menu items -->


              </div>
              <div class="modal" id="myModal">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <!-- Modal Header -->
                    <div class="modal-header">
                      <h4 class="modal-title">Thêm sản phẩm</h4>
                      <button type="button" class="btn-close" id="closeModal" data-bs-dismiss="modal"></button>
                    </div>
                    <!-- Modal body -->
                    <div class="modal-body">
                      <p id="shirtCodeDetail" hidden>Modal body..</p>
                      <p id="shirtDetailName">Modal body..</p>
                      <div class="mb-3">
                        <label for="quantityInput" class="form-label">Số lượng</label>
                        <input type="number" id="quantityInput" class="form-control" placeholder="Nhập số lượng" min="1"
                          value="1">
                      </div>
                    </div>
                    <!-- Modal footer -->
                    <div class="modal-footer">
                      <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-primary" onclick="addItemToCart()">Thêm vào giỏ</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Modal 2 -->
              <div class="modal" id="myModal2">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <!-- Modal Header -->
                    <div class="modal-header">
                      <h4 class="modal-title">Sửa số lượng</h4>
                      <button type="button" class="btn-close" id="closeModal2" data-bs-dismiss="modal"></button>
                    </div>
                    <!-- Modal body -->
                    <div class="modal-body">
                      <p id="shirtCodeDetail2" hidden>Modal body..</p>
                      <p id="shirtDetailName2">Modal body..</p>
                      <div class="mb-3">
                        <label for="quantityInput" class="form-label">Số lượng</label>
                        <input type="number" id="quantityInput2" class="form-control" placeholder="Nhập số lượng"
                          min="1" value="1">
                      </div>
                    </div>
                    <!-- Modal footer -->
                    <div class="modal-footer">
                      <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-primary" onclick="changQuantity()">Xác nhận</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Modal 3 -->
              <div class="modal" id="myModal3">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <!-- Modal Header -->
                    <div class="modal-header">
                      <h4 class="modal-title">Thanh toán</h4>
                      <button type="button" class="btn-close" id="closeModal3" data-bs-dismiss="modal"></button>
                    </div>
                    <!-- Modal body -->
                    <div class="modal-body">
                      <!-- <p id="shirtCodeDetail2">Modal body..</p> -->
                      <!-- <div class="mb-3">
                        <label for="codeVoucher" class="form-label">Mã voucher</label>
                        <input type="text" id="codeVoucher" class="form-control" placeholder="Nhập mã voucher"
                          oninput="applyVoucherOnChange()" />
                        <div id="voucherFeedback" style="display: none; color: red;"></div>
                      </div>
                      <div class="mb-3">
                        <label for="codeCustomer" class="form-label">Khách hàng</label>
                        <input type="text" id="codeCustomer" class="form-control" placeholder="Nhập mã khách hàng"
                          oninput="applyAccountOnChange()">
                        <div id="accountFeedback" class="feedback" style="display:none;"></div>
                      </div>
                      <div class="mb-3">
                        <label for="paymentInput" class="form-label">Tiền phải trả</label>
                        <input type="number" id="totalMoney" class="form-control" readonly>
                      </div>
                      <div class="mb-3">
                        <label for="paymentInput" class="form-label">Tiền khách đưa</label>
                        <input type="number" id="paymentInput" class="form-control" placeholder="Nhập số lượng" min="1"
                          value="1">
                      </div>
                      <div class="mb-3">
                        <label for="changeMoney" class="form-label">Tiền thừa</label>
                        <input type="text" id="changeMoney" class="form-control" readonly>
                      </div> -->
                    </div>
                    <!-- Modal footer -->
                    <div class="modal-footer">
                      <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                      <!-- <button type="button" class="btn btn-primary" id="confirmButton" onclick="checkout()" disabled>Xác
                        nhận</button> -->
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <div class="col-md-4">
              <!-- Invoice Section -->
              <div class="col-lg-12">
                <h3 style="padding-top: 20px;">Hóa Đơn</h3>
                <ul class="list-group mb-3" id="product-list">
                  <!-- Sản phẩm sẽ được thêm vào đây -->
                </ul>


                <div class="card">
                  <div class="card-body">
                    <div class="mb-3">
                      <label hidden for="codeVoucher" class="form-label">Mã voucher</label>
                      <input hidden type="text" id="codeVoucher" class="form-control" placeholder="Nhập mã voucher"
                        oninput="applyVoucherOnChange()" />
                      <div id="voucherFeedback" style="display: none; color: red;"></div>
                    </div>
                    <div>
                      <label for="voucherSelect" class="form-label">Voucher khả dụng:</label>
                      <select id="voucherSelect" class="form-select">
                        <!-- Các option sẽ được thêm động -->
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="codeCustomer" class="form-label">Khách hàng</label>

                      <input hidden type="text" id="codeCustomer" class="form-control" placeholder="Nhập mã khách hàng"
                        oninput="applyAccountOnChange()">
                      <div id="accountFeedback" class="feedback" style="display:none;"></div>
                      <div class="dropdown">
                        <input type="text" id="customerSearch" class="form-control"
                          placeholder="Nhập số điện thoại hoặc tên khách hàng">
                        <ul id="customerList" class="suggestions-list list-group position-absolute w-100"></ul>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="paymentInput" class="form-label">Tiền phải trả</label>
                      <div class="input-group">
                        <input type="number" id="totalMoney" class="form-control" readonly>
                        <span class="input-group-text">VND</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="paymentInput" class="form-label">Tiền khách đưa</label>
                      <div class="input-group">
                        <input type="number" id="paymentInput" class="form-control" placeholder="Nhập số lượng" min="1"
                          value="1">
                        <span class="input-group-text">VND</span>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label for="changeMoney" class="form-label">Tiền thừa</label>
                      <div class="input-group">
                      <input type="text" id="changeMoney" class="form-control" readonly>
                      <span class="input-group-text">VND</span>
                    </div>

                    </div>
                    <button type="button" class="btn btn-primary" id="confirmButton" onclick="checkoutConfirm()"
                      disabled>Xác
                      nhận</button>
                    <button type="button" class="btn btn-danger" onclick="cancel()">
                      <i class="fas fa-times"></i>
                      Hủy đơn
                    </button>
                    <!-- <button class="btn btn-primary w-100" onclick="openModal3()">Place An Order</button> -->
                  </div>
                </div>
              </div>
            </div>
          </div>



        </div>
      </div>
    </div>
    <!-- end container -->

  </div>

  <!-- Custom template | don't include it in your project! -->
  <div class="custom-template">
    <div class="title">Settings</div>
    <div class="custom-content">
      <div class="switcher">
        <div class="switch-block">
          <h4>Logo Header</h4>
          <div class="btnSwitch">
            <button type="button" class="selected changeLogoHeaderColor" data-color="dark"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="blue"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="purple"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="light-blue"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="green"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="orange"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="red"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="white"></button>
            <br />
            <button type="button" class="changeLogoHeaderColor" data-color="dark2"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="blue2"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="purple2"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="light-blue2"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="green2"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="orange2"></button>
            <button type="button" class="changeLogoHeaderColor" data-color="red2"></button>
          </div>
        </div>
        <div class="switch-block">
          <h4>Navbar Header</h4>
          <div class="btnSwitch">
            <button type="button" class="changeTopBarColor" data-color="dark"></button>
            <button type="button" class="changeTopBarColor" data-color="blue"></button>
            <button type="button" class="changeTopBarColor" data-color="purple"></button>
            <button type="button" class="changeTopBarColor" data-color="light-blue"></button>
            <button type="button" class="changeTopBarColor" data-color="green"></button>
            <button type="button" class="changeTopBarColor" data-color="orange"></button>
            <button type="button" class="changeTopBarColor" data-color="red"></button>
            <button type="button" class="selected changeTopBarColor" data-color="white"></button>
            <br />
            <button type="button" class="changeTopBarColor" data-color="dark2"></button>
            <button type="button" class="changeTopBarColor" data-color="blue2"></button>
            <button type="button" class="changeTopBarColor" data-color="purple2"></button>
            <button type="button" class="changeTopBarColor" data-color="light-blue2"></button>
            <button type="button" class="changeTopBarColor" data-color="green2"></button>
            <button type="button" class="changeTopBarColor" data-color="orange2"></button>
            <button type="button" class="changeTopBarColor" data-color="red2"></button>
          </div>
        </div>
        <div class="switch-block">
          <h4>Sidebar</h4>
          <div class="btnSwitch">
            <button type="button" class="changeSideBarColor" data-color="white"></button>
            <button type="button" class="selected changeSideBarColor" data-color="dark"></button>
            <button type="button" class="changeSideBarColor" data-color="dark2"></button>
          </div>
          <!-- Repeat for other menu items -->

        </div>
      </div>
    </div>
    <div class="custom-toggle">
      <i class="icon-settings"></i>
    </div>
  </div>
  <!-- End Custom template -->
  </div>
  <!--   Core JS Files   -->
  <script src="js/core/jquery-3.7.1.min.js"></script>
  <script src="js/core/popper.min.js"></script>
  <script src="js/core/bootstrap.min.js"></script>

  <!-- jQuery Scrollbar -->
  <script src="js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>

  <!-- Chart JS -->
  <script src="js/plugin/chart.js/chart.min.js"></script>

  <!-- jQuery Sparkline -->
  <script src="/js/plugin/jquery.sparkline/jquery.sparkline.min.js"></script>

  <!-- Chart Circle -->
  <script src="js/plugin/chart-circle/circles.min.js"></script>

  <!-- Datatables -->
  <script src="js/plugin/datatables/datatables.min.js"></script>

  <!-- Bootstrap Notify -->
  <script src="js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>

  <!-- jQuery Vector Maps -->
  <script src="js/plugin/jsvectormap/jsvectormap.min.js"></script>
  <script src="js/plugin/jsvectormap/world.js"></script>

  <!-- Sweet Alert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Thêm CSS của Toastr -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

  <!-- Thêm JavaScript của Toastr -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

  <!-- Kaiadmin JS -->
  <script src="js/kaiadmin.min.js"></script>

  <!-- Kaiadmin DEMO methods, don't include it in your project! -->
  <script src="js/setting-demo.js"></script>
  <script src="js/demo.js"></script>
  <script src="js/oders.js"></script>

  <style>
    body {
      background-color: #f8f8f8;
    }

    .navbar {
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    }

    .card {
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      border: none;
      border-radius: 8px;
    }

    .list-group-item {
      font-size: 14px;
    }

    .card-body h5 {
      font-weight: bold;
    }


    .suggestions-list {
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      /* Đảm bảo hiển thị trên các thành phần khác */
      border: 1px solid #ddd;
      background-color: white;
      border-radius: 0 0 5px 5px;
      margin-top: -1px;
      /* Để tránh khoảng trống giữa input và ul */
    }

    .suggestions-list li {
      padding: 10px;
      cursor: pointer;
    }

    .suggestions-list li:hover {
      background-color: #f1f1f1;
    }

    button.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }

    /* CSS cho lớp highlight */
    .highlight {
      background-color: #f0f8ff;
      /* Màu nền khi highlight */
      font-weight: bold;
      /* Có thể thêm các hiệu ứng khác */
    }

    /* Tooltip CSS */
    .tooltip {
      position: absolute;
      background-color: #333;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
    }

    .button-container:hover .tooltip {
      opacity: 1;
      transform: translateY(0);
    }

    .table-container {
      max-height: 400px;
      /* Chiều cao cố định của bảng */
      overflow-y: auto;
      /* Hiển thị thanh cuộn dọc khi cần */
    }

    .table-container table {
      width: 100%;
      /* Đảm bảo bảng chiếm đủ chiều rộng */
      border-collapse: collapse;
    }

    .table-container thead {
      position: sticky;
      /* Giữ cố định phần header */
      top: 0;
      /* Cố định ở đầu */
      background-color: #f8f9fa;
      /* Màu nền để phần header dễ nhìn */
      z-index: 1;
      /* Đảm bảo header luôn nổi trên nội dung */
    }

    .table-container th,
    .table-container td {
      padding: 8px;
      text-align: left;
      border: 1px solid #dee2e6;
    }

    .table-container th {
      font-weight: bold;
    }
  </style>

  <style>
    body {
      background-color: #f8f8f8;
    }

    .navbar {
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    }

    .card {
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      border: none;
      border-radius: 8px;
    }

    .list-group-item {
      font-size: 14px;
    }

    .card-body h5 {
      font-weight: bold;
    }


    .suggestions-list {
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;

      display: none;
      /* Mặc định ẩn */

      /* Đảm bảo hiển thị trên các thành phần khác */
      border: 1px solid #ddd;
      background-color: white;
      border-radius: 0 0 5px 5px;
      margin-top: -1px;
      /* Để tránh khoảng trống giữa input và ul */
    }

    .suggestions-list li {
      padding: 10px;
      cursor: pointer;
    }

    .suggestions-list li:hover {
      background-color: #f1f1f1;
    }

    button.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }

    /* CSS cho lớp highlight */
    .highlight {
      background-color: #f0f8ff;
      /* Màu nền khi highlight */
      font-weight: bold;
      /* Có thể thêm các hiệu ứng khác */
    }

    .pagination {
      justify-content: center;
    }

    .page-item.active .page-link {
      background-color: #007bff;
      color: white;
    }
  </style>

  <script type="text/javascript">

    let noVoucher = true;

    const userCode = sessionStorage.getItem("userCode");

    let activeBillCode = 'none';

    let currentCodeShirtDetail = 'none';

    let currentCodeBillDetail = 'none';

    let camStat = true;

    let activeVoucherCode = null

    let subtotal = 0

    let vouchers = null

    const formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }); // Định dạng VNĐ

    const tableBody = document.getElementById("billDetailsTableBody");

    const apiUrl = "http://localhost:8080/point-of-sale/get-pending-bill";

    const token2 = sessionStorage.getItem('jwtToken');

    const feedback = document.getElementById("accountFeedback");


    // Tạo một đối tượng headers chứa token
    const headers = {
      'Authorization': `Bearer ${token2}`,
      'Content-Type': 'application/json'
    };


    async function fetchBillDetails(codeBill) {

      try {
        const response = await fetch(`http://localhost:8080/point-of-sale/get-bill-detail?codeBill=${codeBill}`, {
          method: 'GET',
          headers: headers // Thêm headers vào yêu cầu
        });

        const responseBill = await fetch(`http://localhost:8080/point-of-sale/get-bill?codeBill=${codeBill}`, {
          method: 'GET',
          headers: headers // Thêm headers vào yêu cầu
        });

        // Kiểm tra xem phản hồi có thành công không
        if (!response.ok) {
          throw new Error('Network response was not ok ' + response.statusText);
        }

        currentCodeShirtDetail = 'none';

        tableBody.innerHTML = ""; // Xóa dữ liệu cũ nếu có

        // Chuyển đổi dữ liệu thành JSON
        const data = await response.json();

        data.forEach((detail, index) => {
          const row = document.createElement("tr");
          const total = detail.price * detail.quantity;

          row.innerHTML = `
      <td>${index + 1}</td>
      <td>${detail.shirtDetail.codeShirtDetail}</td>
      <td>${detail.shirtDetail.shirt.nameshirt}</td>
      <td>${detail.shirtDetail.size.namesize}</td>
      <td>${detail.shirtDetail.color.nameColor}</td>
      <td>${formatter.format(detail.price)}</td>
      <td>${detail.quantity}</td>
      <td>${formatter.format(total)}</td>
      <td>
    <!-- Nút "Sửa" -->

    <button type="button" class="btn btn-primary btn-sm" onclick="openModal2('${detail.codeBillDetail}','${detail.shirtDetail.codeShirtDetail}')">
        <i class="fas fa-pen"></i> Sửa
    </button>
    <!-- Nút "Xóa" -->

    <button type="button" class="btn btn-danger btn-sm" onclick="remove('${detail.codeBillDetail}')">
        <i class="fas fa-trash"></i> Xóa
    </button>
</td>
    `;
          tableBody.appendChild(row);
        });

        // // Lấy phần tử danh sách
        // const productList = document.getElementById('product-list');

        // // Xóa các phần tử cũ trong danh sách
        // productList.innerHTML = '';

        // // Khai báo biến để tính toán tổng tiền
        // let subtotal = 0;
        // let tax = 0; // Giả sử bạn có một tỷ lệ thuế cố định hoặc tính toán theo yêu cầu

        // // Duyệt qua từng sản phẩm và thêm vào danh sách
        // data.forEach(item => {
        //   const listItem = document.createElement('li');
        //   listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

        //   // Tính toán subtotal
        //   const itemTotal = item.price * item.quantity; // Tính tổng cho từng sản phẩm
        //   subtotal += itemTotal; // Cộng dồn vào subtotal

        //   // Tạo nội dung cho mỗi sản phẩm
        //   listItem.innerHTML = `
        //         ${item.shirtDetail.codeShirtDetail}
        //         <span>${item.quantity}x</span>
        //         <span>$${item.price}</span>
        //     `;

        //   listItem.addEventListener('click', () => {
        //     // Kiểm tra xem hàng hiện tại có đang được highlight không
        //     if (listItem.classList.contains('highlight')) {
        //       // Nếu đang highlight, bỏ highlight
        //       listItem.classList.remove('highlight');
        //       currentCodeShirtDetail = 'none';
        //       currentCodeBillDetail = 'none';
        //     } else {
        //       // Nếu chưa highlight, bỏ highlight ở các hàng khác và thêm highlight cho hàng này
        //       document.querySelectorAll('.list-group-item').forEach(item => {
        //         item.classList.remove('highlight');
        //       });
        //       listItem.classList.add('highlight');
        //       currentCodeShirtDetail = item.shirtDetail.codeShirtDetail;
        //       currentCodeBillDetail = item.codeBillDetail;
        //     }

        //   });

        //   // Thêm phần tử vào danh sách
        //   productList.appendChild(listItem);
        // });

        // if (activeBillCode == 'none') {
        //   productList.innerHTML = '';
        //   subtotal = 0;
        // }

        // // Giả sử tỷ lệ thuế là 4%
        // tax = subtotal * 0.04;

        // // Tính toán tổng tiền
        // const totalPayment = subtotal + tax;

        // // Cập nhật giao diện
        // activeBillCode = codeBill;
        // document.getElementById('subtotal').innerText = `$${subtotal}`;
        // document.getElementById('tax').innerText = `$${tax}`;
        // document.getElementById('totalPayment').innerText = `$${totalPayment}`;

        // Cập nhật trạng thái active cho nút
        const buttons = document.querySelectorAll('#bill-buttons button');
        buttons.forEach(button => {
          button.classList.toggle('active', button.value === codeBill); // Thêm/lớp active nếu trùng mã hóa đơn
        });


        feedback.style.display = "block";
        feedback.textContent = "";


        if (codeBill === 'none') {
          // Gán giá trị rỗng khi codeBill là 'none'
          document.getElementById('codeCustomer').value = '';
          document.getElementById('customerSearch').value = '';
        } else {
          const dataBill = await responseBill.json();

          // Gán giá trị từ dữ liệu trả về nếu có
          document.getElementById('codeCustomer').value = dataBill.customer?.username || '';
          document.getElementById('customerSearch').value = dataBill.customer?.username || '';
        }

        moneyCaculating()
        fetchProducts();

      } catch (error) {
        console.error('There was a problem with the fetch operation:', error);
      }
    }


    // Hiển thị tooltip khi hover vào nút bill
    function showTooltip(button, codeBillDetail, createAt) {
      let tooltip = document.createElement("div");
      tooltip.className = "tooltip";

      // Kiểm tra dữ liệu và hiển thị tooltip
      tooltip.innerText = codeBillDetail && codeBillDetail.length > 0
        ? `Chi tiết: ${codeBillDetail}\nNgày tạo: ${createAt}`
        : "Không có dữ liệu";

      button.appendChild(tooltip);
    }

    // Ẩn tooltip khi rời chuột khỏi nút bill
    function hideTooltip(button) {
      let tooltip = button.querySelector(".tooltip");
      if (tooltip) {
        tooltip.remove();
      }
    }

    // Thêm sự kiện vào các nút bill
    async function fetchBills() {
      try {
        const response = await fetch(apiUrl, {
          method: 'GET',
          headers: headers
        });
        const bills = await response.json();

        if (bills.length > 0) {
          activeBillCode = bills[0].codeBill;
          fetchBillDetails(activeBillCode);

          toggleInputFields(activeBillCode);
        } else {
          activeBillCode = "none";
          fetchBillDetails(activeBillCode);
          toggleInputFields(activeBillCode);
        }

        const billButtonsContainer = document.getElementById('bill-buttons');
        billButtonsContainer.innerHTML = '';

        bills.forEach(bill => {
          const button = document.createElement('button');
          button.className = 'btn btn-outline-primary m-1 button-container';
          button.textContent = bill.codeBill;
          button.value = bill.codeBill;

          if (bill.codeBill === activeBillCode) {
            button.classList.add('active');
          }

          button.addEventListener('click', () => {
            fetchBillDetails(bill.codeBill);
            activeBillCode = bill.codeBill;
          });

          // Gọi API để lấy chi tiết bill
          button.addEventListener('mouseenter', async () => {
            const detailsResponse = await fetch(`http://localhost:8080/point-of-sale/get-bill-detail?codeBill=${bill.codeBill}`, {
              method: 'GET',
              headers: headers
            });
            const details = await detailsResponse.json();
            const codeBillDetail = details.map(detail => detail.codeBillDetail).join(", ");
            showTooltip(button, codeBillDetail, bill.createAt);
          });

          button.addEventListener('mouseleave', () => {
            hideTooltip(button);
          });

          billButtonsContainer.appendChild(button);
        });
      } catch (error) {
        console.error('Lỗi khi gọi API:', error);
      }
    }


    // Gọi hàm fetchBills khi trang load
    window.onload = fetchBills;


    async function creatBill() {
      const response = await fetch(apiUrl, {
        method: 'GET',
        headers: headers
      });
      const bills = await response.json();

      if (bills.length >= 5) {
        toastr.error('Đã đạt số lượng hóa đơn tối đa', 'Lỗi');
        return;
      }

      fetch(`http://localhost:8080/point-of-sale/create-blank-bill`, {
        method: 'GET',
        headers: headers
      }).then(data => {
        console.log("Create blank bill successfully", data);
        currentCodeShirtDetail = 'none';
        fetchBills()
      }
      ).catch(error => console.error("Error creating blank bill", error));

    }

    function confirmCheckout() {
      Swal.fire({
        title: 'Xác nhận',
        text: 'Bạn có chắc chắn muốn thanh toán không?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Có',
        cancelButtonText: 'Hủy',
      }).then((result) => {
        if (result.isConfirmed) {
          // Nếu người dùng chọn "Có", gọi hàm checkout()
          Swal.fire('Thành công!', 'Đã thanh toán hóa đơn.', 'success');
          checkout();
        } else {
          // Nếu người dùng chọn "Hủy", không làm gì cả
          Swal.fire('Đã hủy!', 'Không có thay đổi nào được thực hiện.', 'info');
        }
      });
    }


    async function checkout() {
      let codeVoucherCheckout = document.getElementById("codeVoucher").value;
      const username = document.getElementById("codeCustomer").value;

      const resp = await fetch(`http://localhost:8080/point-of-sale/get-bill-detail?codeBill=${activeBillCode}`, {
        method: 'GET',
        headers: headers // Thêm headers vào yêu cầu
      });

      if (!resp.ok) {
        toastr.error('Không thể kết nối tới máy chủ hoặc xảy ra lỗi', 'Lỗi');
        return;
      }

      const data = await resp.json(); // Parse dữ liệu trả về dưới dạng JSON

      if (!Array.isArray(data) || data.length === 0) {
        toastr.error('Hóa đơn chưa có sản phẩm nào', 'Lỗi');
        return;
      }
      if (noVoucher) { codeVoucherCheckout = 'none'; }

      fetch(`http://localhost:8080/point-of-sale/checkout?codeBill=${activeBillCode}&codeVoucher=${activeVoucherCode}&username=${username}&userCode=${userCode}`, {
        method: 'POST',
        headers: headers
      }).then(data => {
        console.log("Check out successfully", data);
        currentCodeShirtDetail = 'none';
        fetchBills()
        document.getElementById('closeModal3').click()
        toastr.success('Đã hoàn tất thanh toán!', 'Thành công');
        
      }
      ).catch(error => console.error("Error with checkout", error));
    }

    function cancel() {
      if (activeBillCode == 'none') {
        toastr.error('Chưa chọn hóa đơn', 'Lỗi');
        return;
      }
      fetch(`http://localhost:8080/point-of-sale/cancel?codeBill=${activeBillCode}`, {
        method: 'POST',
        headers: headers
      }).then(data => {
        console.log("Cancel successfully", data);
        currentCodeShirtDetail = 'none';

        fetchBillDetails(activeBillCode)
        moneyCaculating()
        fetchProducts()
        fetchBills()
        toastr.success('Hủy đơn thành công', 'Thành công');
      }
      ).catch(error => console.error("Error with canceling", error));
    }

    async function scanBarcode() {
      if (activeBillCode === 'none') {
        toastr.error('Chưa chọn hóa đơn', 'Lỗi');
        return;
      }

      const codeBill = activeBillCode;

      if (camStat) {
        try {
          const response = await fetch(`http://localhost:8080/point-of-sale/scanBarcode?billCode=${encodeURIComponent(codeBill)}`, {
            method: 'GET',
            headers: headers
          });

          const result = await response.text();
          console.log("Kết quả quét mã vạch:", result);

          if (result === "Webcam end") {
            console.log("Webcam đã kết thúc, không mở modal.");
            return; // Kết thúc hàm mà không làm gì thêm
          }

          if (result === "Timeout") {
            toastr.error("Quá thời gian, đã tự động tắt");
            return; // Kết thúc hàm mà không làm gì thêm
          }

          // Gán kết quả quét vào phần tử shirtCodeDetail
          document.getElementById("shirtCodeDetail").innerText = result;

          const rppp = await fetch(`http://localhost:8080/point-of-sale/get-shirt-detail?codeShirtDetail=${result}`, {
            method: 'GET',
            headers: headers
          });
          const sd = await rppp.json();
          console.log(sd.shirt.nameshirt);

          // Kiểm tra dữ liệu trước khi thao tác
          if (sd && sd.shirt && sd.shirt.nameshirt && sd.size && sd.size.namesize && sd.color && sd.color.nameColor) {
            document.getElementById("shirtDetailName").innerText =
              `${sd.shirt.nameshirt} - ${sd.size.namesize} - ${sd.color.nameColor}`;
          } else {
            throw new Error("Dữ liệu trả về không đầy đủ");
          }

          // Đặt lại số lượng về 1
          document.getElementById("quantityInput").value = 1;

          // Gọi checkScan để kiểm tra sản phẩm
          const isProductValid = await checkScan(result);
          if (!isProductValid) {
            return; // Không mở modal nếu sản phẩm không hợp lệ
          }

          // Mở modal
          openModal();
        } catch (error) {
          console.error("Lỗi trong scanBarcode:", error);
          toastr.error("Không tìm thấy sản phẩm");
        }

        camStat = false;
      } else {
        try {
          await fetch(`http://localhost:8080/point-of-sale/close`, {
            method: 'GET',
            headers: headers
          });
        } catch (error) {
          console.error("Error closing webcam:", error);
        }

        camStat = true;
      }
    }

    async function checkScan(codeShirtDetail) {
      const response = await fetch(`http://localhost:8080/point-of-sale/get-shirt-detail?codeShirtDetail=${codeShirtDetail}`, {
        method: 'GET',
        headers: headers
      });
      const textResponse = await response.text();
      console.log(textResponse)
      if (!textResponse) {
        toastr.error("Không tìm thấy sản phẩm");
        return false;
      } else { return true; }
    }

    async function performSearch() {
      const searchInput = document.getElementById("searchInput");
      const suggestionsList = document.getElementById("suggestions");

      if (searchInput.value.length < 1) {
        suggestionsList.innerHTML = ''; // Nếu không có từ khóa tìm kiếm, ẩn danh sách
        suggestionsList.style.display = 'none'; // Ẩn hoàn toàn danh sách
        return;
      }

      if (searchInput.value.length > 0) {
        try {
          const response = await fetch(`http://localhost:8080/point-of-sale/search?query=${encodeURIComponent(searchInput.value)}`, {
            method: 'GET',
            headers: headers // Thêm headers vào yêu cầu
          });

          const data = await response.json();
          suggestionsList.innerHTML = "";

          // Kiểm tra nếu không có kết quả tìm kiếm
          if (data.length === 0) {
            suggestionsList.style.display = 'none'; // Ẩn danh sách khi không có kết quả
            return;
          }

          // Xử lý dữ liệu khi có kết quả tìm kiếm
          data.forEach(item => {
            let suggestionItem = document.createElement("li");
            suggestionItem.innerHTML = `${item.shirt.nameshirt} ${item.size.namesize} ${item.color.nameColor} ${item.material.nameMaterial}`;

            suggestionItem.onclick = async function () {
              if (activeBillCode == 'none') {
                toastr.error('Chưa chọn hóa đơn', 'Lỗi');
                return;
              }

              // Call the /add/ endpoint when a suggestion is clicked
              document.getElementById("shirtCodeDetail").innerText = item.codeShirtDetail;

              try {
                const shirtResponse = await fetch(`http://localhost:8080/point-of-sale/get-shirt-detail?codeShirtDetail=${item.codeShirtDetail}`, {
                  method: 'GET',
                  headers: headers
                });
                const sd = await shirtResponse.json();
                console.log(sd.shirt.nameshirt);

                // Kiểm tra dữ liệu trước khi thao tác
                if (sd && sd.shirt && sd.shirt.nameshirt && sd.size && sd.size.namesize && sd.color && sd.color.nameColor) {
                  document.getElementById("shirtDetailName").innerText = `${sd.shirt.nameshirt} - ${sd.size.namesize} - ${sd.color.nameColor}`;
                } else {
                  throw new Error("Dữ liệu trả về không đầy đủ");
                }
              } catch (error) {
                console.error("Lỗi khi lấy chi tiết sản phẩm:", error);
                toastr.error("Không thể lấy chi tiết sản phẩm.");
              }

              openModal(); // Gọi hàm mở modal
              suggestionsList.innerHTML = ""; // Clear suggestions after the click
              searchInput.value = ""; // Clear search input after selection
            };

            suggestionsList.appendChild(suggestionItem);
          });

          suggestionsList.style.display = 'block';
        } catch (error) {
          console.error("Lỗi khi tìm kiếm sản phẩm:", error);
          suggestionsList.innerHTML = "<li>Không thể tìm kiếm. Vui lòng thử lại!</li>";
        }
      } else {
        suggestionsList.innerHTML = "";
      }

      // Sự kiện blur: khi người dùng rời khỏi ô tìm kiếm
      searchInput.addEventListener("blur", () => {
        // Đợi một thời gian ngắn trước khi ẩn danh sách để người dùng có thể click vào một mục
        setTimeout(() => {
          suggestionsList.style.display = 'none'; // Ẩn danh sách khi rời khỏi ô tìm kiếm
        }, 200);
      });

      // Sự kiện focus: khi người dùng quay lại ô tìm kiếm
      searchInput.addEventListener("focus", () => {
        const sq = searchInput.value.trim();
        if (sq.length > 0) {
          suggestionsList.style.display = 'block'; // Hiển thị lại danh sách khi người dùng focus vào ô tìm kiếm
        }
      });
    }


    // Gọi hàm `performSearch` khi người dùng nhập vào ô tìm kiếm
    document.getElementById("searchInput").addEventListener("input", performSearch);


    function openModal() {
      document.getElementById("quantityInput").value = 1;

      var myModal = new bootstrap.Modal(document.getElementById('myModal'), {
        keyboard: false // Thay đổi nếu bạn muốn tắt tính năng đóng bằng phím ESC
      });
      myModal.show(); // Mở modal
    }

    async function addItemToCart() {

      const codeBill = activeBillCode;
      const codeShirtDetail = document.getElementById("shirtCodeDetail").innerText;
      const quantity = document.getElementById("quantityInput").value;

      const response = await fetch(`http://localhost:8080/point-of-sale/get-shirt-detail?codeShirtDetail=${codeShirtDetail}`, {
        method: 'GET',
        headers: headers
      });
      const sd = await response.json();
      if (0 >= quantity || quantity % 1 != 0 || quantity > 2147483647) {
        toastr.error('Số lượng không hợp lệ', 'Lỗi');
        document.getElementById("quantityInput").value = 1
        return;
      }
      if (sd.quantity < quantity) {
        toastr.error('Vượt quá số lượng tối đa', 'Lỗi');
        document.getElementById("quantityInput").value = sd.quantity
        return;
      }

      // Send a POST request to the /add/ endpoint with the item ID
      fetch(`http://localhost:8080/point-of-sale/add-to-cart?codeShirtDetail=${codeShirtDetail}&codeBill=${codeBill}&quantity=${quantity}`, {
        method: 'POST',
        headers: headers
      })
        // .then(response => response.json())
        .then
        (data => {
          console.log("Item added to cart:", data);
          // You can update the UI or show a message that the item has been added
          document.getElementById("searchInput").value = "";
          fetchBillDetails(codeBill);
          camStat = true;
          toastr.success('Thêm sản phẩm thành công', 'Thành công');
        })
        .catch(error => console.error("Error adding item to cart:", error));
      document.getElementById('closeModal').click()
    }



    async function openModal2(codeBillDetail, codeShirtDetail) {
      document.getElementById("shirtCodeDetail2").innerText = codeShirtDetail;
      const response = await fetch(`http://localhost:8080/point-of-sale/get-shirt-detail?codeShirtDetail=${codeShirtDetail}`, {
        method: 'GET',
        headers: headers
      });
      const sd = await response.json();
      console.log(sd.shirt.nameshirt);

      // Kiểm tra dữ liệu trước khi thao tác
      if (sd && sd.shirt && sd.shirt.nameshirt && sd.size && sd.size.namesize && sd.color && sd.color.nameColor) {
        document.getElementById("shirtDetailName2").innerText =
          `${sd.shirt.nameshirt} - ${sd.size.namesize} - ${sd.color.nameColor}`;
      } else {
        throw new Error("Dữ liệu trả về không đầy đủ");
      }
      document.getElementById("quantityInput2").value = 1;
      currentCodeBillDetail = codeBillDetail
      var myModal = new bootstrap.Modal(document.getElementById('myModal2'), {
        keyboard: false // Thay đổi nếu bạn muốn tắt tính năng đóng bằng phím ESC
      });
      myModal.show(); // Mở modal
    }

    async function changQuantity() {

      const codeBill = activeBillCode;
      const codeShirtDetail = document.getElementById("shirtCodeDetail2").innerText;
      const codeBillDetail = currentCodeBillDetail;
      const quantity = document.getElementById("quantityInput2").value;

      const response = await fetch(`http://localhost:8080/point-of-sale/get-shirt-detail?codeShirtDetail=${codeShirtDetail}`, {
        method: 'GET',
        headers: headers
      });
      const sd = await response.json();

      if (0 >= quantity || 2147483647 < quantity || quantity % 1 != 0) {
        toastr.error('Số lượng không hợp lệ', 'Lỗi');
        document.getElementById("quantityInput2").value = 1
        return;
      }
      if (sd.quantity < quantity) {
        toastr.error('Vượt quá số lượng tối đa', 'Lỗi');
        document.getElementById("quantityInput2").value = sd.quantity
        return;
      }

      // Send a POST request to the /add/ endpoint with the item ID
      fetch(`http://localhost:8080/point-of-sale/change-quantity?codeBillDetail=${codeBillDetail}&quantity=${quantity}`, {
        method: 'POST',
        headers: headers
      })
        // .then(response => response.json())
        .then
        (data => {
          console.log("Item changed:", data);
          // You can update the UI or show a message that the item has been added
          // document.getElementById("searchInput").value = "";
          fetchBillDetails(codeBill);
          toastr.success('Sửa số lượng sản phẩm thành công', 'Thành công');
          // camStat = true;
        })
        .catch(error => console.error("Error adding item to cart:", error));
      document.getElementById('closeModal2').click()
    }

    async function moneyCaculating() {
      try {
        // Lấy thông tin chi tiết hóa đơn từ API
        const response = await fetch(`http://localhost:8080/point-of-sale/get-bill-detail?codeBill=${activeBillCode}`, {
          method: 'GET',
          headers: headers
        });

        if (!response.ok) {
          throw new Error('Error fetching bill details');
        }

        const data = await response.json();

        // Tính tổng tiền
        subtotal = 0;
        data.forEach(item => {
          subtotal += item.price * item.quantity;
        });

        updateVoucherOptions(subtotal)

        // Hiển thị tổng tiền vào ô input
        document.getElementById('totalMoney').value = subtotal;

        // Reset các ô nhập liệu
        document.getElementById('codeVoucher').value = ''; // Xóa mã voucher
        document.getElementById('voucherFeedback').style.display = 'none'; // Ẩn thông báo
        document.getElementById('paymentInput').value = ''; // Tiền khách đưa
        document.getElementById('changeMoney').value = ''; // Tiền thừa
        document.getElementById('confirmButton').disabled = true; // Tắt nút Xác nhận

        // Thêm sưj kiện validate
        document.getElementById('paymentInput').oninput = validatePayment;

      } catch (error) {
        console.error('Error:', error);
      }
    }

    function validatePayment() {
      const totalMoney = parseFloat(document.getElementById('totalMoney').value) || 0;
      const paymentInput = parseFloat(document.getElementById('paymentInput').value) || 0;

      // Tính tiền thừa
      const changeMoney = paymentInput - totalMoney;

      // Hiển thị tiền thừa
      const changeMoneyInput = document.getElementById('changeMoney');
      changeMoneyInput.value = changeMoney > 0 ? changeMoney : 0;

      // Bật/tắt nút Xác nhận
      const confirmButton = document.getElementById('confirmButton');
      confirmButton.disabled = paymentInput < totalMoney;
    }

    async function applyAccountOnChange() {
      const codeCustomer = document.getElementById("codeCustomer").value.trim();
      const codeVoucherInput = document.getElementById("codeVoucher");
      // const feedback = document.getElementById("accountFeedback");
      const totalMoneyInput = document.getElementById("totalMoney");
      const voucherFeedback = document.getElementById("voucherFeedback");
      // Ẩn thông báo cũ
      feedback.style.display = "none";
      voucherFeedback.style.display = "none";

      try {
        const billResponse = await fetch(`http://localhost:8080/point-of-sale/get-bill-detail?codeBill=${activeBillCode}`, {
          method: 'GET',
          headers: headers
        });

        const billData = await billResponse.json();

        // Tính tổng tiền
        let totalMoney = 0;
        billData.forEach(item => {
          totalMoney += item.price * item.quantity;
        });

        // Gửi yêu cầu kiểm tra mã khách hàng
        const response = await fetch(`http://localhost:8080/point-of-sale/get-account?username=${codeCustomer}`, {
          method: "GET",
          headers: headers,
        });

        // Kiểm tra phản hồi từ API
        if (!response.ok) {
          throw new Error("Mã khách hàng không hợp lệ hoặc không tồn tại!");
        }


        const responseClone = response.clone();

        const data = await responseClone.text();
        if (data == '') {
          // feedback.style.display = "block";
          // feedback.textContent = "";

          totalMoneyInput.value = totalMoney;
          validatePayment()
          applyVoucherOnChange()
          return;
        }

        // Đọc dữ liệu từ API
        const accountData = await response.json();

        // Nếu không tìm thấy tài khoản
        if (!accountData || Object.keys(accountData).length === 0) {
          // feedback.style.display = "block";
          // feedback.style.color = "red";
          // feedback.textContent = "Không tìm thấy tài khoản với mã khách hàng này!";
          codeVoucherInput.disabled = true; // Vô hiệu hóa ô nhập mã voucher
          codeVoucherInput.value = ""; // Xóa mã voucher
          totalMoneyInput.value = ""; // Đặt lại tổng tiền
          return;
        }

        // Nếu tìm thấy tài khoản, bật ô nhập voucher
        // feedback.style.display = "block";
        // feedback.style.color = "green";
        // feedback.textContent = `Tài khoản hợp lệ`;
        codeVoucherInput.disabled = false; // Kích hoạt ô nhập mã voucher

        // Gửi yêu cầu kiểm tra mã khách hàng
        const customerResponse = await fetch(`http://localhost:8080/point-of-sale/update-customer-info?codeBill=${activeBillCode}&username=${codeCustomer}`, {
          method: "POST",
          headers: headers,
        }).then(data => {
          console.log("Update customer info: ", data);
        }
        ).catch(error => console.error("Error", error));

        // Gọi lại hàm áp dụng voucher
        await applyVoucherOnChange();
      } catch (error) {
        // Hiển thị lỗi nếu xảy ra
        // feedback.style.display = "block";
        // feedback.style.color = "red";
        // feedback.textContent = error.message || "Đã xảy ra lỗi khi kiểm tra mã khách hàng!";
        codeVoucherInput.disabled = true; // Vô hiệu hóa ô nhập mã voucher
        codeVoucherInput.value = ""; // Xóa mã voucher

        totalMoneyInput.value = totalMoney;
        validatePayment()
        return;

      }
    }




    async function applyVoucherOnChange() {
      const codeCustomer = document.getElementById("codeCustomer").value.trim();
      const codeVoucher = document.getElementById("codeVoucher").value.trim();
      const totalMoneyInput = document.getElementById("totalMoney");
      const feedback = document.getElementById("voucherFeedback");

      // Ẩn thông báo
      feedback.style.display = "none";

      try {
        // Gửi yêu cầu kiểm tra mã khách hàng
        // const customerResponse = await fetch(`http://localhost:8080/point-of-sale/get-account?username=${codeCustomer}`, {
        //   method: "GET",
        //   headers: headers,
        // });

        // // Kiểm tra phản hồi từ API
        // if (!customerResponse.ok) {
        //   throw new Error("Mã khách hàng không hợp lệ hoặc không tồn tại!");
        // }

        // const customerData = await customerResponse.text();
        // if (customerData == '') {
        //   return;
        // }

        const response = await fetch(`http://localhost:8080/point-of-sale/get-bill-detail?codeBill=${activeBillCode}`, {
          method: 'GET',
          headers: headers
        });

        const data = await response.json();

        // Tính tổng tiền
        let totalMoney = 0;
        data.forEach(item => {
          totalMoney += item.price * item.quantity;
        });

        // Nếu không có mã voucher, giữ nguyên tổng tiền
        if (!codeVoucher) {
          totalMoneyInput.value = totalMoney;
          validatePayment()
          return;
        }

        // Gửi yêu cầu lấy voucher
        const voucherResponse = await fetch(`http://localhost:8080/point-of-sale/get-voucher?codeVoucher=${codeVoucher}`, {
          method: "GET",
          headers: headers
        });

        if (!voucherResponse.ok) {
          throw new Error("Mã voucher không hợp lệ hoặc không tồn tại!");
        }
        const voucherResponseClone = voucherResponse.clone();

        const voucherData = await voucherResponse.text();
        if (voucherData == '') {
          feedback.style.display = "block";
          feedback.textContent = "";
          totalMoneyInput.value = totalMoney; // Giữ nguyên tổng tiền
          validatePayment()
          return;
        }

        const voucher = await voucherResponseClone.json();

        // Kiểm tra nếu voucher không hợp lệ
        if (!voucher) {
          feedback.style.display = "block";
          feedback.textContent = "Mã voucher không hợp lệ hoặc đã hết hạn!";
          totalMoneyInput.value = totalMoney; // Giữ nguyên tổng tiền

          noVoucher = true
          validatePayment()
          return;
        }

        // Kiểm tra điều kiện áp dụng voucher
        if (voucher.min_bill_value > totalMoney) {
          feedback.style.display = "block";
          feedback.style.color = "red";
          feedback.textContent = `Hóa đơn phải từ ${voucher.min_bill_value} mới áp dụng được voucher này.`;

          noVoucher = true
          totalMoneyInput.value = totalMoney; // Giữ nguyên tổng tiền
          validatePayment()
          return;
        }


        noVoucher = false;
        // Tính toán giảm giá
        let discount = 0;
        // if (voucher.type_voucher === "Percent") {
        //   discount = Math.min(totalMoney * (voucher.discount_value / 100), voucher.maximum_discount);
        // } else if (voucher.type_voucher === "Amount") {
        //   discount = Math.min(voucher.discount_value, voucher.maximum_discount);
        // }

        if (voucher.type_voucher === "Percent") {
          discount = Math.min(totalMoney * (voucher.discount_value / 100), voucher.maximum_discount);
        } else if (voucher.type_voucher === "Amount") {
          discount = Math.min(voucher.discount_value, voucher.maximum_discount);
        }

        // Cập nhật tổng tiền
        const newTotal = totalMoney - discount;


        totalMoneyInput.value = newTotal > 0 ? newTotal : 0;
        validatePayment()

        // Hiển thị thông báo thành công
        // feedback.style.display = "block";
        // feedback.style.color = "green";
        // feedback.textContent = `Áp dụng voucher thành công! Giảm giá: ${discount}`;
      } catch (error) {
        // Hiển thị lỗi nếu có
        feedback.style.display = "block";
        feedback.style.color = "red";
        feedback.textContent = error.message || "Đã xảy ra lỗi trong quá trình áp dụng voucher!";
      }
    }



    function remove(codeBillDetail) {
      const codeBill = activeBillCode;
      // const codeBillDetail = currentCodeBillDetail;
      fetch(`http://localhost:8080/point-of-sale/remove-item-from-cart?codeBillDetail=${codeBillDetail}`, {
        method: 'POST',
        headers: headers
      }).then(data => {
        console.log("Remove successfully", data);
        currentCodeBillDetail = 'none';
        fetchBillDetails(codeBill);
      }
      ).catch(error => console.error("Error with removing", error));
    }

    const pageSize = 5; // Số sản phẩm mỗi trang
    let currentPage = 1; // Trang hiện tại
    let products = []; // Lưu danh sách sản phẩm

    async function fetchProducts() {
      try {
        const response = await fetch("http://localhost:8080/point-of-sale/get-all-shirt-detail", {
          method: "GET",
          headers: headers,
        });

        if (!response.ok) {
          throw new Error("Không thể lấy dữ liệu sản phẩm!");
        }

        products = await response.json(); // Lưu toàn bộ sản phẩm
        renderTable(); // Hiển thị sản phẩm
        renderPagination(); // Hiển thị phân trang
      } catch (error) {
        console.error(error.message);
        console.log("Đã xảy ra lỗi khi tải dữ liệu sản phẩm!");
      }
    }

    function renderTable() {
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, products.length);
      const currentProducts = products.slice(startIndex, endIndex);

      const tableBody = document.getElementById("productTableBody");
      tableBody.innerHTML = ""; // Xóa dữ liệu cũ

      currentProducts.forEach((product, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
      <td>${startIndex + index + 1}</td>
      <td>${product.codeShirtDetail}</td>
      <td>${product.shirt.nameshirt}</td>
      <td>${product.size.namesize}</td>
      <td>${product.color.nameColor}</td>
      <td>${formatter.format(product.price)}</td>
      <td>${product.quantity}</td>
      <td>
        <button class="btn btn-primary btn-sm" onclick="add('${product.codeShirtDetail}')">Chọn</button>
      </td>
    `;
        tableBody.appendChild(row);
      });
    }

    // Hàm xử lý khi bấm nút
    async function add(codeShirtDetail) {
      if (activeBillCode == 'none') {
        toastr.error('Chưa chọn hóa đơn', 'Lỗi');
        return;
      }
      document.getElementById("shirtCodeDetail").innerText = codeShirtDetail;

      const response = await fetch(`http://localhost:8080/point-of-sale/get-shirt-detail?codeShirtDetail=${codeShirtDetail}`, {
        method: 'GET',
        headers: headers
      });
      const sd = await response.json();
      console.log(sd.shirt.nameshirt);

      // Kiểm tra dữ liệu trước khi thao tác
      if (sd && sd.shirt && sd.shirt.nameshirt && sd.size && sd.size.namesize && sd.color && sd.color.nameColor) {
        document.getElementById("shirtDetailName").innerText =
          `${sd.shirt.nameshirt} - ${sd.size.namesize} - ${sd.color.nameColor}`;
      } else {
        throw new Error("Dữ liệu trả về không đầy đủ");
      }

      openModal(); // Gọi hàm mở modal
    }

    function renderPagination() {
      const totalPages = Math.ceil(products.length / pageSize); // Tổng số trang
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = ""; // Xóa nội dung phân trang cũ

      const maxVisiblePages = 7; // Tổng số phần tử hiển thị
      const sidePages = Math.floor((maxVisiblePages - 3) / 2); // Số trang mỗi bên (trừ «, », ...)
      let startPage, endPage;

      if (currentPage <= 4) {
        // Khi đang ở trang đầu (hoặc gần đầu)
        startPage = 1;
        endPage = Math.min(maxVisiblePages - 2, totalPages); // Hiển thị các trang từ đầu
      } else if (currentPage >= totalPages - 3) {
        // Khi đang ở cuối (hoặc gần cuối)
        startPage = Math.max(1, totalPages - (maxVisiblePages - 3));
        endPage = totalPages; // Hiển thị các trang cuối
      } else {
        // Khi ở giữa
        startPage = currentPage - sidePages;
        endPage = currentPage + sidePages;
      }

      // Nút "Trước"
      const prevLi = document.createElement("li");
      prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
      prevLi.innerHTML = `<a class="page-link" onclick="changePage(${currentPage - 1})">&laquo;</a>`;
      pagination.appendChild(prevLi);

      // Nút đầu tiên và "..."
      if (startPage > 1) {
        const firstLi = document.createElement("li");
        firstLi.className = "page-item";
        firstLi.innerHTML = `<a class="page-link" onclick="changePage(1)">1</a>`;
        pagination.appendChild(firstLi);

        if (startPage > 2) {
          const dotsLi = document.createElement("li");
          dotsLi.className = "page-item disabled";
          dotsLi.innerHTML = `<a class="page-link">...</a>`;
          pagination.appendChild(dotsLi);
        }
      }

      // Các trang ở giữa
      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === currentPage ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
      }

      // Nút "..." và cuối cùng
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const dotsLi = document.createElement("li");
          dotsLi.className = "page-item disabled";
          dotsLi.innerHTML = `<a class="page-link">...</a>`;
          pagination.appendChild(dotsLi);
        }

        const lastLi = document.createElement("li");
        lastLi.className = "page-item";
        lastLi.innerHTML = `<a class="page-link" onclick="changePage(${totalPages})">${totalPages}</a>`;
        pagination.appendChild(lastLi);
      }

      // Nút "Tiếp"
      const nextLi = document.createElement("li");
      nextLi.className = `page-item ${currentPage === totalPages ? "disabled" : ""}`;
      nextLi.innerHTML = `<a class="page-link" onclick="changePage(${currentPage + 1})">&raquo;</a>`;
      pagination.appendChild(nextLi);
    }





    function changePage(page) {
      currentPage = page;
      renderTable(); // Hiển thị sản phẩm theo trang
      renderPagination(); // Cập nhật phân trang
    }

    // Gọi hàm lấy dữ liệu khi tải trang
    fetchProducts();





    function toggleInputFields(activeBillCode) {
      const customerCodeInput = document.getElementById("customerSearch");
      const voucherInput = document.getElementById("codeVoucher");
      const changeAmountInput = document.getElementById("paymentInput");

      // Kiểm tra nếu activeBillCode là "none"
      const isDisabled = activeBillCode === "none";

      // Cập nhật trạng thái của các ô nhập
      customerCodeInput.disabled = isDisabled;
      voucherInput.disabled = isDisabled;
      changeAmountInput.disabled = isDisabled;

      // Nếu bị vô hiệu hóa, xóa giá trị trong các ô nhập
      if (isDisabled) {
        customerCodeInput.value = "";
        voucherInput.value = "";
        changeAmountInput.value = "";
      }
    }

    // Ví dụ: Cập nhật trạng thái khi trang được tải
    document.addEventListener("DOMContentLoaded", () => {
      toggleInputFields(activeBillCode); // Giả sử `activeBillCode` được khai báo trước đó
    });



    async function setupCustomerSearch() {
      const customerInput = document.getElementById("customerSearch");
      const customerList = document.getElementById("customerList");

      // Thêm sự kiện khi nhập dữ liệu vào ô tìm kiếm
      customerInput.addEventListener("input", async (e) => {
        const searchQuery = e.target.value.trim().toLowerCase();

        if (searchQuery.length < 1) {
          customerList.innerHTML = ''; // Nếu không có từ khóa tìm kiếm, ẩn danh sách
          customerList.style.display = 'none'; // Ẩn hoàn toàn danh sách
          return;
        }

        document.getElementById("codeCustomer").value = searchQuery
        applyAccountOnChange()

        try {
          // Gửi yêu cầu đến API để lấy danh sách khách hàng
          const response = await fetch("http://localhost:8080/point-of-sale/get-all-customer", {
            method: "GET",
            headers: headers, // Nếu cần thêm headers như Authorization, thêm tại đây
          });

          if (!response.ok) {
            throw new Error("Không thể tải danh sách khách hàng");
          }

          const customers = await response.json();

          // Lọc danh sách khách hàng theo username và số điện thoại
          const filteredCustomers = customers.filter((customer) => {
            return (
              customer.username.toLowerCase().includes(searchQuery) ||
              customer.phone.includes(searchQuery)
            );
          });

          // Xóa danh sách cũ
          customerList.innerHTML = "";

          // Kiểm tra nếu không có kết quả tìm kiếm
          if (filteredCustomers.length === 0) {
            customerList.style.display = 'none'; // Ẩn danh sách khi không có kết quả
            return;
          }

          // Hiển thị danh sách khách hàng
          filteredCustomers.forEach((customer) => {
            const listItem = document.createElement("li");
            listItem.textContent = `${customer.username} - ${customer.phone}`;
            listItem.classList.add("dropdown-item");
            listItem.addEventListener("click", () => {
              // Cập nhật giá trị ô tìm kiếm khi chọn khách hàng
              customerInput.value = customer.username;
              document.getElementById("codeCustomer").value = customer.username
              applyVoucherOnChange()

              customerList.innerHTML = ""; // Ẩn danh sách khi chọn xong
              customerList.style.display = 'none'; // Ẩn danh sách khi chọn xong
              // Gửi yêu cầu kiểm tra mã khách hàng
              const customerResponse = fetch(`http://localhost:8080/point-of-sale/update-customer-info?codeBill=${activeBillCode}&username=${customer.username}`, {
                method: "POST",
                headers: headers,
              }).then(data => {
                console.log("Update customer info: ", data);
              }
              ).catch(error => console.error("Error", error));
              // Thực hiện các thao tác cần thiết với thông tin khách hàng đã chọn
              handleCustomerSelection(customer);
            });

            customerList.appendChild(listItem);
          });

          // Hiển thị lại danh sách sau khi có kết quả tìm kiếm
          customerList.style.display = 'block';

        } catch (error) {
          console.error("Lỗi khi tìm kiếm khách hàng:", error);
        }
      });

      // Thêm sự kiện khi rời khỏi ô input (blur)
      customerInput.addEventListener("blur", () => {
        // Đợi một thời gian ngắn trước khi ẩn danh sách để người dùng có thể click vào một mục
        setTimeout(() => {
          customerList.style.display = 'none'; // Ẩn danh sách khi rời khỏi ô tìm kiếm
        }, 200);
      });

      // Thêm sự kiện focus để đảm bảo danh sách được hiển thị lại khi người dùng quay lại ô tìm kiếm
      customerInput.addEventListener("focus", () => {
        const searchQuery = customerInput.value.trim();
        if (searchQuery.length > 0) {
          customerList.style.display = 'block'; // Hiển thị lại danh sách khi người dùng focus vào ô tìm kiếm
        }
      });
    }
    function getMyProfile() {
      const token = sessionStorage.getItem("jwtToken");

      if (!token) {
        alert("Bạn cần đăng nhập để xem thông tin cá nhân.");
        return;
      }

      fetch("http://localhost:8080/admin/myProfile", {
        method: "GET",
        headers: {
          Authorization: "Bearer " + token,
        },
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Có lỗi xảy ra khi lấy thông tin người dùng.");
          }
          return response.json();
        })
        .then((data) => {
          if (data && data.result) {
            const profile = data.result;
            console.log(profile)

            // Cập nhật avatar và tên trên thanh điều hướng
            const avatarImg = document.querySelector(".avatar-sm img");
            const usernameSpan = document.querySelector(".profile-username .fw-bold");

            avatarImg.src = profile.avatar || "default-avatar.jpg";
            usernameSpan.textContent = profile.firstName || "Người dùng";

            // Cập nhật thông tin trong dropdown
            const userBox = document.getElementById("user-box");
            const profileAvatar = document.getElementById("profile-avatar");
            const userName = document.getElementById("user-name");
            const userEmail = document.getElementById("user-email");

            profileAvatar.src = profile.avatar || "default-avatar.jpg";
            userName.textContent = `${profile.firstName || ""} ${profile.lastName || ""}`;
            userEmail.textContent = profile.email || "Không có email";
            userBox.style.display = "block"; // Hiển thị box sau khi tải dữ liệu
          } else {
            alert("Không thể lấy thông tin người dùng.");
          }
        })
        .catch((error) => {
          alert(error.message);
        });
    }

    function logout() {
      sessionStorage.removeItem("jwtToken");
      window.location.href = "/assets/account/login.html";
    }

    // Gọi hàm khi trang tải xong
    document.addEventListener("DOMContentLoaded", () => {
      getMyProfile();

      // Gán sự kiện logout
      const logoutButton = document.getElementById("logout");
      logoutButton.addEventListener("click", logout);
    });



    // Hàm xử lý khi chọn khách hàng
    function handleCustomerSelection(customer) {
      console.log("Khách hàng được chọn:", customer);
      // Thực hiện các thao tác với khách hàng đã chọn, ví dụ:
      // - Cập nhật thông tin khách hàng trên giao diện
      // - Gửi yêu cầu xác nhận khách hàng
    }

    setupCustomerSearch();



    async function updateVoucherOptions(money) {
      const voucherSelect = document.getElementById("voucherSelect");

      try {
        // Gọi API để lấy danh sách voucher khả dụng
        const response = await fetch(`http://localhost:8080/point-of-sale/find-avaiable-voucher?money=${money}`, {
          method: "GET",
          headers: headers,
        });
        if (!response.ok) throw new Error("Không thể lấy danh sách voucher");

        vouchers = await response.json();

        // Xóa các tùy chọn cũ
        voucherSelect.innerHTML = "";

        // Kiểm tra nếu không có voucher
        if (vouchers.length === 0) {
          activeVoucherCode=null;
          voucherSelect.innerHTML = "<option value=''>Không có voucher khả dụng</option>";
          return;
        }

        // Thêm các voucher vào danh sách
        let maxDiscount = 0;
        let bestVoucher = null;

        if (vouchers.length > 0) {
          const defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.textContent = "Không chọn voucher";
          voucherSelect.appendChild(defaultOption);
        }

        vouchers.forEach((voucher) => {
          discountValue = voucher.type_voucher === "Percent"
            ? Math.min(voucher.maximum_discount, money * (voucher.discount_value / 100))
            : Math.min(voucher.discount_value, voucher.maximum_discount);

          if (discountValue > maxDiscount) {
            maxDiscount = discountValue;
            bestVoucher = voucher;
          }

          const option = document.createElement("option");
          option.value = voucher.code_voucher;
          option.textContent = `Đơn tối thiểu: ${formatter.format(voucher.min_bill_value)} - Giảm tối đa: ${formatter.format(voucher.maximum_discount)} VNĐ`;
          voucherSelect.appendChild(option);
        });

        // Tự động chọn voucher giảm nhiều nhất
        if (bestVoucher) {
          activeVoucherCode = bestVoucher.code_voucher
          voucherSelect.value = bestVoucher.code_voucher;
          document.getElementById("codeVoucher").value = voucherSelect.value;
          applyVoucherOnChange()
        }
      } catch (error) {
        console.error("Lỗi khi cập nhật voucher:", error);
      }
    }

    const vs = document.getElementById('voucherSelect');

    vs.addEventListener('change', async function () {
      try {
        // Lấy mã voucher được chọn
        activeVoucherCode = this.value;

        // Nếu không có voucher được chọn (giá trị rỗng), cập nhật lại tổng tiền và dừng xử lý
        if (!activeVoucherCode) {
          console.log("Không có voucher được chọn");
          document.getElementById('totalMoney').value = subtotal;
          return;
        }


        // Tìm thông tin voucher từ danh sách đã tải
        const selectedVoucher = vouchers.find(voucher => voucher.code_voucher === activeVoucherCode);

        if (!selectedVoucher) {
          console.warn("Voucher không tồn tại trong danh sách đã tải.");
          return;
        }

        // Tính giá trị giảm giá
        const discountValue = selectedVoucher.type_voucher === "Percent"
          ? Math.min(selectedVoucher.maximum_discount, subtotal * (selectedVoucher.discount_value / 100))
          : Math.min(selectedVoucher.discount_value, selectedVoucher.maximum_discount);

        const lastMoney = subtotal - discountValue;

        discount = discountValue

        // Cập nhật các thông tin hiển thị liên quan
        document.getElementById('totalMoney').value = lastMoney
        // document.getElementById('selected-total').innerText = `${lastMoney} VNĐ`;
        // document.getElementById('ship-money').innerText = `${ship} VNĐ`;
        // document.getElementById('all-the-money').innerText = `${ship + lastMoney} VNĐ`;

        // console.log(`Voucher selected: ${activeVoucherCode}, giảm giá: ${discountValue} VNĐ`);
      } catch (error) {
        console.error("Lỗi khi xử lý thay đổi voucher:", error);
      }
    });

    function checkoutConfirm() {
      Swal.fire({
        title: 'Xác nhận thanh toán?',
        text: 'Bạn có chắc chắn muốn thực hiện thanh toán không?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Thanh toán',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33'
      }).then((result) => {
        if (result.isConfirmed) {
          // Gọi hàm checkout nếu người dùng xác nhận
          checkout();
        } else {
          // Có thể thêm thông báo hủy nếu cần
          toastr.info('Bạn đã hủy thanh toán.', 'Thông báo');
        }
      });

    }


    toastr.options = {
      "closeButton": true,               // Hiển thị nút đóng
      "debug": false,                    // Chế độ debug
      "newestOnTop": true,               // Hiển thị thông báo mới nhất lên trên
      "progressBar": true,               // Hiển thị thanh tiến trình

      "positionClass": "toast-top-right",// Vị trí hiển thị
      "preventDuplicates": true,         // Ngăn chặn thông báo trùng lặp
      "onclick": null,                   // Hành động khi click
      "showDuration": "300",             // Thời gian hiển thị (ms)
      "hideDuration": "1000",            // Thời gian ẩn (ms)
      "timeOut": "5000",                 // Tự động tắt sau 5 giây
      "extendedTimeOut": "1000",         // Thời gian mở rộng khi di chuột
      "showEasing": "swing",             // Hiệu ứng hiển thị
      "hideEasing": "linear",            // Hiệu ứng ẩn
      "showMethod": "fadeIn",            // Cách hiển thị
      "hideMethod": "fadeOut"            // Cách ẩn
    };
  </script>

  <script>
    $("#lineChart").sparkline([102, 109, 120, 99, 110, 105, 115], {
      type: "line",
      height: "70",
      width: "100%",
      lineWidth: "2",
      lineColor: "#177dff",
      fillColor: "rgba(23, 125, 255, 0.14)",
    });

    $("#lineChart2").sparkline([99, 125, 122, 105, 110, 124, 115], {
      type: "line",
      height: "70",
      width: "100%",
      lineWidth: "2",
      lineColor: "#f3545d",
      fillColor: "rgba(243, 84, 93, .14)",
    });

    $("#lineChart3").sparkline([105, 103, 123, 100, 95, 105, 115], {
      type: "line",
      height: "70",
      width: "100%",
      lineWidth: "2",
      lineColor: "#ffa534",
      fillColor: "rgba(255, 165, 52, .14)",
    });
  </script>
</body>

</html>